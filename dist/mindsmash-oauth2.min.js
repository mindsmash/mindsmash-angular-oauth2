/**
 * @name mindsmash-oauth2
 * @version v1.0.0
 * @author mindsmash GmbH
 * @license MIT
 */
!function(e){"use strict";!function(){e.module("mindsmash.oauth2",["rails","angular-jwt"]).config(["$httpProvider",function(e){e.interceptors.push("mindsmashOauth2Interceptor")}])}(),function(){e.module("mindsmash.oauth2").provider("Auth",function(){var t=null,n=null,r="oauth/token";this.apiBaseUrl=function(e){t=e},this.basicAuthCode=function(e){n=e},this.oauthPath=function(e){r=e},this.$get=["railsResourceFactory","railsSerializer",function(o,u){function i(e,t){return s.$post(s.$url(),"grant_type=password&username="+encodeURIComponent(e)+"&password="+encodeURIComponent(t))}function a(e){return s.$post(s.$url()+"?grant_type=refresh_token&refresh_token="+e)}function c(){return"Basic "+n}var s=o({url:t+"/"+r,name:"auth",httpConfig:{headers:{Authorization:c(),"Content-Type":"application/x-www-form-urlencoded"},skipAuthorization:!0},rootWrapping:!1,serializer:u({camelize:function(e){return e}},function(){})});return e.extend(s,{login:i,refreshToken:a}),e.extend(s.prototype,{}),s}]})}(),function(){e.module("mindsmash.oauth2").provider("AuthUser",function(){var t=null;this.url=function(e){t=e},this.$get=["railsResourceFactory","railsSerializer",function(n,r){var o=n({url:t,name:"authUser",rootWrapping:!1,serializer:r({camelize:function(e){return e}},function(){})});return e.extend(o,{findByUsername:function(e){return o.get({username:e})}}),e.extend(o.prototype,{}),o}]})}(),function(){e.module("mindsmash.oauth2").provider("authService",function(){var e=!1;this.debugMode=function(){e=!0},this.$get=["$rootScope","$q","$window","Auth","authUserService","jwtHelper",function(t,n,r,o,u,i){function a(e,r,i){return o.login(e,r).then(function(r){return A(e),T("access_token expires in "+r.expires_in/60+" minutes"),j.isAuthValid(r)?(j.setTokens(r),t.$broadcast("auth.login"),i?u.loadUser(i):n.resolve(r)):n.reject(r)},function(e){return m(),400===e.status&&"invalid_grant"===e.data.error&&(t.$broadcast("auth.login.invalid"),T("invalid credentials")),t.$broadcast("auth.unauthenticated"),n.reject(e)})}function c(){m(),_(),u.clearUser(),t.$broadcast("auth.logout");var e=n.defer();return e.resolve(!0),e.promise}function s(){var e=j.getRefreshToken();return m(),T("access token invalid - trying to refresh with refresh token"),o.refreshToken(e).then(function(e){return T("access_token expires in "+e.expires_in/60+" minutes"),j.isAuthValid(e)?(j.setTokens(e),n.resolve()):(j.failAuthentication(),n.reject(e))},function(e){return j.failAuthentication(),n.reject(e)})}function l(){return"Bearer "+j.getAccessToken()}function f(){return r.localStorage.access_token||null}function h(){return r.localStorage.refresh_token||null}function d(e){return e.access_token&&e.refresh_token}function g(e){r.localStorage.access_token=e.access_token,r.localStorage.refresh_token=e.refresh_token}function m(){delete r.localStorage.access_token,delete r.localStorage.refresh_token}function p(){var e=j.getAccessToken();return null!==e?i.decodeToken(e):null}function v(e){var t=j.getClaims();return null!==t?t[e]:null}function k(){var e=j.getAccessToken();return null!==e}function $(){t.$broadcast("auth.unauthenticated"),j.logout(),t.$broadcast("auth.logout.auto")}function A(e){r.localStorage.username=e}function S(){return r.localStorage.username||j.getClaim("user_name")||null}function _(){delete r.localStorage.username}function U(){return u}function T(t,n){if(e){var r="authService - "+t+(n?" :":"");n?console.log(r,n):console.log(r)}}var j={login:a,logout:c,refreshToken:s,getBearer:l,getAccessToken:f,getRefreshToken:h,isAuthValid:d,setTokens:g,unsetTokens:m,getClaims:p,getClaim:v,isAuthenticated:k,failAuthentication:$,getUsername:S,getUserService:U};return j}]})}(),function(){e.module("mindsmash.oauth2").provider("authUserService",function(){var e=!1;this.debugMode=function(){e=!0},this.$get=["$injector","$rootScope","$q","$timeout",function(t,n,r,o){function u(e){var s=t.get("authService");if(i()){if(d===!0)return o(function(){return u()},50)}else if(d=!0,s.isAuthenticated())return e.findByUsername(s.getUsername()).then(function(e){return h("loaded connected user with id "+e.id),c(e),n.$broadcast("auth.user.loaded"),e},function(e){return h("failed to load connected user",e),f(),n.$broadcast("auth.user.failed"),!e||403!==e.status&&404!==e.status||(n.$broadcast("auth.logout.auto"),s.logout()),null})["finally"](function(){d=!1});var l=r.defer();return l[null!==a()?"resolve":"reject"](a()),l.promise}function i(){return null!==g}function a(){return g}function c(e){g=e}function s(e){g=e}function l(){return f(),u()}function f(){g=null}function h(t,n){if(e){var r="authUserService - "+t+(n?" :":"");n?console.log(r,n):console.log(r)}}var d=!1,g=null,m={loadUser:u,getUser:a,updateUser:s,refreshUser:l,clearUser:f};return m}]})}(),function(){e.module("mindsmash.oauth2").factory("mindsmashOauth2Interceptor",["$injector","$q",function(e,t){return{request:function(t){var n=e.get("authService");return t.skipAuthorization?t:(null===n.getAccessToken()||void 0!==t.headers.Authorization&&-1===t.headers.Authorization.indexOf("Bearer")||(t.headers.Authorization=n.getBearer()),t)},responseError:function(n){var r=e.get("$http"),o=e.get("authService");if(401===n.status){if(0===n.config.url.indexOf("/oauth/token"))return o.failAuthentication(),t.reject();var u=n.data.error&&"invalid_token"===n.data.error,i=null!==o.getRefreshToken();return u&&i?o.refreshToken().then(function(){return r(n.config)},function(){return o.failAuthentication(),t.reject(n)}):(o.failAuthentication(),t.reject(n))}return t.reject(n)}}}])}()}(angular);