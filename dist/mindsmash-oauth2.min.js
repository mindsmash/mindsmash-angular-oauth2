/**
 * @name mindsmash-oauth2
 * @version v1.0.3
 * @author mindsmash GmbH
 * @license MIT
 */
!function(e){"use strict";!function(){e.module("mindsmash.oauth2",["rails","angular-jwt"]).config(["$httpProvider",function(e){e.interceptors.push("mindsmashOauth2Interceptor")}])}(),function(){e.module("mindsmash.oauth2").provider("Auth",function(){var t=null,n=null,r="oauth/token";this.apiBaseUrl=function(e){t=e},this.basicAuthCode=function(e){n=e},this.oauthPath=function(e){r=e},this.$get=["railsResourceFactory","railsSerializer",function(o,i){function u(e,t){return c.$post(c.$url(),"grant_type=password&username="+encodeURIComponent(e)+"&password="+encodeURIComponent(t))}function a(e){return c.$post(c.$url()+"?grant_type=refresh_token&refresh_token="+e)}function s(){return"Basic "+n}var c=o({url:t+"/"+r,name:"auth",httpConfig:{headers:{Authorization:s(),"Content-Type":"application/x-www-form-urlencoded"},skipAuthorization:!0},rootWrapping:!1,serializer:i({camelize:function(e){return e}},function(){})});return e.extend(c,{login:u,refreshToken:a}),e.extend(c.prototype,{}),c}]})}(),function(){e.module("mindsmash.oauth2").provider("AuthUser",function(){var t=null;this.url=function(e){t=e},this.$get=["railsResourceFactory","railsSerializer",function(n,r){var o=n({url:t,name:"authUser",rootWrapping:!1,serializer:r({camelize:function(e){return e}},function(){})});return e.extend(o,{findByUsername:function(e){return o.get({username:e})}}),e.extend(o.prototype,{}),o}]})}(),function(){e.module("mindsmash.oauth2").provider("authService",function(){var e=!1;this.debugMode=function(){e=!0},this.$get=["$rootScope","$q","$window","Auth","authUserService","jwtHelper",function(t,n,r,o,i,u){function a(e,r,u){return o.login(e,r).then(function(r){return $(e),T("access_token expires in "+r.expires_in/60+" minutes"),y.isAuthValid(r)?(y.setTokens(r),t.$broadcast("auth.login"),u?i.loadUser(u):n.resolve(r)):n.reject(r)},function(e){return m(),400===e.status&&"invalid_grant"===e.data.error&&(t.$broadcast("auth.login.invalid"),T("invalid credentials")),t.$broadcast("auth.unauthenticated"),n.reject(e)})}function s(){m(),_(),i.clearUser(),t.$broadcast("auth.logout");var e=n.defer();return e.resolve(!0),e.promise}function c(){var e=y.getRefreshToken();return T("access token invalid - trying to refresh with refresh token"),o.refreshToken(e).then(function(e){return T("access_token expires in "+e.expires_in/60+" minutes"),y.isAuthValid(e)?(y.setTokens(e),n.resolve()):(y.failAuthentication(),n.reject(e))},function(e){return y.failAuthentication(),n.reject(e)})}function l(){return"Bearer "+y.getAccessToken()}function f(){return r.localStorage.access_token||null}function h(){return r.localStorage.refresh_token||null}function d(e){return e.access_token&&e.refresh_token}function g(e){r.localStorage.access_token=e.access_token,r.localStorage.refresh_token=e.refresh_token}function m(){delete r.localStorage.access_token,delete r.localStorage.refresh_token}function p(){var e=y.getAccessToken();return null!==e?u.decodeToken(e):null}function v(e){var t=y.getClaims();return null!==t?t[e]:null}function k(){var e=y.getAccessToken();return null!==e}function A(){t.$broadcast("auth.unauthenticated"),y.logout(),t.$broadcast("auth.logout.auto")}function $(e){r.localStorage.username=e}function S(){return r.localStorage.username||y.getClaim("user_name")||null}function _(){delete r.localStorage.username}function U(){return i}function T(t,n){if(e){var r="authService - "+t+(n?" :":"");n?console.log(r,n):console.log(r)}}var y={login:a,logout:s,refreshToken:c,getBearer:l,getAccessToken:f,getRefreshToken:h,isAuthValid:d,setTokens:g,unsetTokens:m,getClaims:p,getClaim:v,isAuthenticated:k,failAuthentication:A,getUsername:S,getUserService:U};return y}]})}(),function(){e.module("mindsmash.oauth2").provider("authUserService",function(){var e="roles",t=!1;this.rolesProperty=function(t){e=t},this.debugMode=function(){t=!0},this.$get=["$injector","$rootScope","$q","$timeout",function(e,n,r,o){function i(t){var c=e.get("authService");if(u()){if(m===!0)return o(function(){return i()},50)}else if(m=!0,c.isAuthenticated())return t.findByUsername(c.getUsername()).then(function(e){return g("loaded connected user with id "+e.id),s(e),n.$broadcast("auth.user.loaded"),e},function(e){return g("failed to load connected user",e),f(),n.$broadcast("auth.user.failed"),!e||403!==e.status&&404!==e.status||(n.$broadcast("auth.logout.auto"),c.logout()),null})["finally"](function(){m=!1});var l=r.defer();return l[null!==a()?"resolve":"reject"](a()),l.promise}function u(){return null!==p}function a(){return p}function s(e){p=e}function c(e){p=e}function l(){return f(),i()}function f(){p=null}function h(e){var t=!1;return a().getRoles().forEach(function(n){-1!==e.indexOf(n)&&(t=!0)}),t}function d(e){var t=!0,n=a().getRoles();return e.split(",").forEach(function(e){e=e.trim(),-1===n.indexOf(e)&&(t=!1)}),t}function g(e,n){if(t){var r="authUserService - "+e+(n?" :":"");n?console.log(r,n):console.log(r)}}var m=!1,p=null,v={loadUser:i,getUser:a,updateUser:c,refreshUser:l,clearUser:f,hasAnyPermission:h,hasAllPermissions:d};return v}]})}(),function(){e.module("mindsmash.oauth2").factory("mindsmashOauth2Interceptor",["$injector","$q",function(e,t){return{request:function(t){var n=e.get("authService");return t.skipAuthorization?t:(null===n.getAccessToken()||void 0!==t.headers.Authorization&&-1===t.headers.Authorization.indexOf("Bearer")||(t.headers.Authorization=n.getBearer()),t)},responseError:function(n){var r=e.get("$http"),o=e.get("authService");if(401===n.status){if(-1!==n.config.url.indexOf("/oauth/token"))return o.failAuthentication(),t.reject();var i=n.data.error&&"invalid_token"===n.data.error,u=null!==o.getRefreshToken();return i&&u?o.refreshToken().then(function(){return r(n.config)},function(){return o.failAuthentication(),t.reject(n)}):(o.failAuthentication(),t.reject(n))}return t.reject(n)}}}])}()}(angular);